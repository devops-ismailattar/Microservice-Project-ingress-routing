name: cicd-pipeline-for-nodejs
on: push
jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: checkout
              uses: actions/checkout@v6.0.1
            - name: set up nodejs
              uses: actions/setup-node@v6.1.0
              with:
                node-version: 24
            - name: install dependecies
              run: |
                cd app1/cart-app && npm install && ls -l
                cd ../../app2/login-app && npm install && ls -l
                cd ../../app3/payment-app && npm install && ls -l

            - name: sonarqube scan
              uses: SonarSource/sonarqube-scan-action@v7.0.0
              env:
                SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
                SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

            - name: sonarqube quality gate check
              uses: SonarSource/sonarqube-quality-gate-action@v1.2.0
              id: sonarqube-quality-gate-check
              with:
                pollingTimeoutSec: 600
              env:
                SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
                SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
            - name: upload artifact
              uses: actions/upload-artifact@v6.0.0
              with:
                name: cart-app
                path: app1/cart-app/package*.json

            - name: upload artifact
              uses: actions/upload-artifact@v6.0.0
              with:
                name: login-app
                path: app2/login-app/package*.json
            - name: upload artifact
              uses: actions/upload-artifact@v6.0.0
              with:
                name: payment-app
                path: app3/payment-app/package*.json

    build-and-push-docker-image:
        runs-on: ubuntu-latest
        needs: build
        steps:
            - name: checkout
              uses: actions/checkout@v6.0.1
            - name: dowload artifact
              uses: actions/download-artifact@v7.0.0
              with:
                name: cart-app
                path: app1/cart-app/

            - name: dowload artifact
              uses: actions/download-artifact@v7.0.0
              with:
                name: login-app
                path: app2/login-app/
            - name: dowload artifact
              uses: actions/download-artifact@v7.0.0
              with:
                name: payment-app
                path: app3/payment-app/

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v5.1.1
              with:
                aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                aws-region: ap-south-1
            - name: login to ECR
              uses: docker/login-action@v3.6.0
              with:
                registry: 076226033208.dkr.ecr.ap-south-1.amazonaws.com

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Build and push cart docker image 
              uses: docker/build-push-action@v6
              with:
                context: app1/cart-app/.
                push: true
                tags: 076226033208.dkr.ecr.ap-south-1.amazonaws.com/cartapp:${{ github.sha }}

            - name: Build and push login docker image 
              uses: docker/build-push-action@v6
              with:
                context: app2/login-app/.
                push: true
                tags: 076226033208.dkr.ecr.ap-south-1.amazonaws.com/loginapp:${{ github.sha }}

            - name: Build and push payment docker image 
              uses: docker/build-push-action@v6
              with:
                context: app3/payment-app/.
                push: true
                tags: 076226033208.dkr.ecr.ap-south-1.amazonaws.com/paymentapp:${{ github.sha }}

    update-deployment-files:
        runs-on: ubuntu-latest
        needs: build-and-push-docker-image
        permissions:
            contents: write  
        steps:
            - name: checkout
              uses: actions/checkout@v6.0.1
              with:
                token: ${{ secrets.GITHUB_TOKEN }}
            - run: |
                git config user.name "ismail"
                git config user.email "ismailattar@gmail.com"
                sed -i "s|image:.*|image: 076226033208.dkr.ecr.ap-south-1.amazonaws.com/cartapp:${{ github.sha }}|" app1/cart-app-manifest/deployment.yaml
                sed -i "s|image:.*|image: 076226033208.dkr.ecr.ap-south-1.amazonaws.com/loginapp:${{ github.sha }}|" app2/login-app-manifest/deployment.yaml
                sed -i "s|image:.*|image: 076226033208.dkr.ecr.ap-south-1.amazonaws.com/paymentapp:${{ github.sha }}|" app3/payment-app-manifest/deployment.yaml
                git add app1 app2 app3
                git commit -m "Update image tags to ${{ github.sha }}"
                git push origin main
                

            
            





        
            

                
                


